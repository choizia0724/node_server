<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mappers.InvestorFlowMapper">
    <insert id="upsertAll" parameterType="java.util.List">
        INSERT INTO stocks.investor_flow_30m(
        ymd, bucket_start, market_code, investor_type_code, investor_type_name,
        net_qty, net_amt, acml_net_qty, acml_net_amt
        )
        VALUES
        <foreach collection="list" item="r" separator=",">
            (
            #{r.ymd}, #{r.bucketStart}, #{r.marketCode}, #{r.investorTypeCode}, #{r.investorTypeName},
            #{r.netQty}, #{r.netAmt}, #{r.acmlNetQty}, #{r.acmlNetAmt}
            )
        </foreach>
        ON CONFLICT (ymd, bucket_start, market_code, investor_type_code) DO UPDATE SET
        investor_type_name = EXCLUDED.investor_type_name,
        net_qty            = EXCLUDED.net_qty,
        net_amt            = EXCLUDED.net_amt,
        acml_net_qty       = EXCLUDED.acml_net_qty,
        acml_net_amt       = EXCLUDED.acml_net_amt
    </insert>
    <!-- 최신 날짜/시간 내림차순 + 페이징 -->
    <select id="searchMarketFlows" resultType="com.ziapond.portfolio.project.web.dto.InvestorFlowRow">
        SELECT
        ymd,
        bucket_start AS bucketStart,
        market_code  AS marketCode,
        NULL         AS symbol,
        investor_type_code AS investorTypeCode,
        investor_type_name AS investorTypeName,
        net_qty      AS netQty,
        net_amt      AS netAmt,
        acml_net_qty AS acmlNetQty,
        acml_net_amt AS acmlNetAmt
        FROM stocks.investor_flow_30m
        <where>
            <if test="marketCode != null and marketCode != ''">
                AND market_code = #{marketCode}
            </if>
            <if test="investorType != null and investorType != ''">
                AND investor_type_code = #{investorType}
            </if>
            <if test="from != null and to != null">
                AND ymd BETWEEN #{from} AND #{to}
            </if>
            <if test="from != null and to == null">
                AND ymd &gt;= #{from}
            </if>
            <if test="from == null and to != null">
                AND ymd &lt;= #{to}
            </if>
        </where>
        ORDER BY ymd DESC, bucket_start DESC
        LIMIT #{limit}
        OFFSET #{offset}
    </select>

    <select id="countMarketFlows" resultType="long">
        SELECT COUNT(1)
        FROM stocks.investor_flow_30m
        <where>
            <if test="marketCode != null and marketCode != ''">
                AND market_code = #{marketCode}
            </if>
            <if test="investorType != null and investorType != ''">
                AND investor_type_code = #{investorType}
            </if>
            <if test="from != null and to != null">
                AND ymd BETWEEN #{from} AND #{to}
            </if>
            <if test="from != null and to == null">
                AND ymd &gt;= #{from}
            </if>
            <if test="from == null and to != null">
                AND ymd &lt;= #{to}
            </if>
        </where>
    </select>

</mapper>
